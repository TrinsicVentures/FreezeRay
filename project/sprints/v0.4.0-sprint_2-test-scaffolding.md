# Sprint 2: Test Scaffolding

**Version:** v0.4.0
**Dates:** TBD
**Status:** ðŸ“‹ Planned

## Goals

When running `freezeray freeze <version>`, automatically scaffold validation tests:
1. **Drift test** - Verifies frozen schema hasn't changed (calls `__freezeray_check_`)
2. **Migration test** - Tests migration from previous version (calls `__freezeray_test_migrations`)

**Note:** The underlying macro-generated functions (`__freezeray_check_`, `__freezeray_test_migrations`) already exist. This sprint is about CLI scaffolding the test files that call them.

## Specification

### Drift Test Scaffolding

**Generated file:** `{SchemaType}_DriftTests.swift`

```swift
import Testing
import FreezeRay
@testable import MyApp

@Test func testAppSchemaV1_0_0_Drift() throws {
    try AppSchemaV1.__freezeray_check_1_0_0()
    // TODO: Add custom data validation
}
```

- **Scaffolded once** - Never regenerated (user owns the file)
- **Skip if exists** - Don't overwrite user customizations
- **TODO markers** - Guide user to add data validation

### Migration Test Scaffolding

**Generated file:** `MigrateV{prev}toV{curr}_Tests.swift`

Example: `MigrateV2_0_0toV3_0_0_Tests.swift`

```swift
import Testing
import FreezeRay
@testable import MyApp

@Test func testMigrateV2_0_0toV3_0_0() throws {
    try AppMigrations.__freezeray_test_migrate_2_0_0_to_3_0_0()
    // TODO: Add data integrity checks
}
```

- **One test file per migration** - V1â†’V2, V2â†’V3, etc.
- **Find previous version** - Scan `FreezeRay/Fixtures/` and sort semantically
- **Skip if exists** - Don't update existing migration tests

## Implementation Plan

### 1. Find Previous Version
```swift
func findPreviousVersion(_ current: String) -> String? {
    // Scan FreezeRay/Fixtures/ directories
    // Parse semantic versions
    // Return highest version < current
}
```

### 2. Generate Drift Test
```swift
func scaffoldDriftTest(schema: String, version: String) {
    let testFile = "\(schema)_DriftTests.swift"
    guard !FileManager.default.fileExists(atPath: testFile) else { return }
    // Write scaffold with TODO markers
}
```

### 3. Generate Migration Test
```swift
func scaffoldMigrationTest(from: String, to: String) {
    let testFile = "MigrateV\(from)toV\(to)_Tests.swift"
    guard !FileManager.default.fileExists(atPath: testFile) else { return }
    // Write scaffold with TODO markers
}
```

## User Workflow

1. Run `freezeray freeze 3.0.0`
2. CLI creates fixtures + scaffolds tests
3. User adds custom assertions to TODO sections
4. User runs `âŒ˜U` in Xcode - tests validate schema
5. User commits tests alongside fixtures

## Design Decisions

See: [ADR-005: Test Scaffolding (Not Generation)](/project/adr/ADR-005-test-scaffolding-not-generation.md)

**Key principle:** Tests are scaffolded once and owned by the user, not auto-generated.

## Success Criteria

- [ ] Drift test scaffolded on first freeze
- [ ] Migration test scaffolded when previous version exists
- [ ] Tests skipped if files already exist
- [ ] TODO markers guide user customization
- [ ] Tests run with `âŒ˜U` in Xcode (no CLI dependency)
